name: Build macOS

on:
  push:
    tags:
    - '*'

  workflow_dispatch:

jobs:
  build:
    runs-on: macos-15-intel

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          
      - name: Checkout new libnunchuk
        working-directory: ${{ github.workspace }}/nunchuk-desktop/contrib/libnunchuk
        run: |
          git fetch --all --tags --force
          git branch -v -a
          git switch -c updatecore origin/updatecore
          git submodule update --init --recursive
          git status

      - name: Set compiler
        run: |
          #set -e
          sudo xcode-select --switch /Applications/Xcode_16.4.app
          echo "export CC=gcc-14" >> ~/.bashrc
          echo "export CXX=g++-14" >> ~/.bashrc
          source ~/.bashrc
          
      - name: Remove default openssl
        run: |
          rm -rf /usr/local/opt/openssl
          rm -rf /usr/local/include/openssl
          
      - name: Install dependencies
        run: |
          mkdir -p $HOME/boost-1.81.0
          wget https://archives.boost.io/release/1.81.0/source/boost_1_81_0.tar.gz
          tar -xvzf boost_1_81_0.tar.gz
          cd boost_1_81_0          
          ./bootstrap.sh --prefix=$HOME/boost-1.81.0
          #./b2 install 
           # build single-thread and verbose debug output, capture log
          ./b2 install -j1 -d2 --prefix=$HOME/boost-1.81.0 2>&1 | tee $RUNNER_TEMP/boost_install.log || true
          tail -n 200 $RUNNER_TEMP/boost_install.log || true
          # upload log as artifact for inspection
          echo "Uploading boost_install.log"
          ls -la $RUNNER_TEMP/boost_install.log
          
      - name: Brew install remaining deps
        run: |
          export HOMEBREW_NO_INSTALLED_DEPENDENTS_CHECK=1
          export HOMEBREW_NO_AUTO_UPDATE=1
          brew install libolm libevent
      
      - name: Install Qt 5.15.2
        uses: jurplel/install-qt-action@v4
        with:
          version: '5.15.2'
          host: 'mac'
          modules: 'qtwebengine'
  
      - name: Configure Qt5 paths
        run: |
          QTPATH="${{ github.workspace }}/Qt/5.15.2/clang_64"
          echo "QTPATH=$QTPATH" >> $GITHUB_ENV
          echo "CMAKE_PREFIX_PATH=$QTPATH/lib/cmake" >> $GITHUB_ENV
          echo "PATH=$QTPATH/bin:$PATH" >> $GITHUB_ENV
          
      - name: Install qtkeychain
        working-directory: ${{ github.workspace }}
        run: |
          QTPATH="${{ github.workspace }}/Qt/5.15.2/clang_64"
          git clone --depth 1 --branch 0.14.2 https://github.com/frankosterfeld/qtkeychain
          cd qtkeychain
          mkdir build && cd build
          cmake .. -DCMAKE_PREFIX_PATH="$QTPATH/lib/cmake" -DCMAKE_OSX_DEPLOYMENT_TARGET=13.0
          CORES=$(sysctl -n hw.ncpu)
          cmake --build . -j$CORES
          sudo cmake --install . --prefix "/usr/local"
          
      - name: Build openssl
        working-directory: ${{ github.workspace }}/nunchuk-desktop/contrib/libnunchuk/contrib/openssl
        run: |
          set -e
          source ~/.bashrc
          ./config --prefix="$PWD/lib"
          CORES=$(sysctl -n hw.ncpu)
          make -j$CORES
          make install_dev
          
      - name: Build nunchuk-qt
        working-directory: ${{ github.workspace }}
        env:
          OPENSSL_ROOT_DIR: ${{ github.workspace }}/nunchuk-desktop/contrib/libnunchuk/contrib/openssl/lib
        run: |
          set -e
          QTPATH="${{ github.workspace }}/Qt/5.15.2/clang_64"
          export PATH="$QTPATH/bin:$PATH"
          export LDFLAGS="$LDFLAGS -L$QTPATH/lib -L$HOME/boost-1.81.0/lib -L/usr/local/opt/berkeley-db@4/lib"
          export CPPFLAGS="$CPPFLAGS -I$QTPATH/include -I$HOME/boost-1.81.0/include -I/usr/local/opt/berkeley-db@4/include -I$OPENSSL_ROOT_DIR/include"
          export BOOST_ROOT="$HOME/boost-1.81.0"
          export CXXFLAGS="$CXXFLAGS -O0"
          export CFLAGS="$CFLAGS -O0"
          cmake -E make_directory ${{ github.workspace }}/build
          cd build
          cmake ${{ github.workspace }}/nunchuk-desktop \
                -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_PREFIX_PATH="$QTPATH/lib/cmake" \
                -DUR__DISABLE_TESTS=ON \
                -DBOOST_ROOT=$HOME/boost-1.81.0 \
                -DCMAKE_CXX_FLAGS="$CXXFLAGS" \
                -DCMAKE_C_FLAGS_RELEASE="$CFLAGS" \
                -DCMAKE_CXX_FLAGS_RELEASE="$CXXFLAGS" \
                -DCMAKE_OSX_DEPLOYMENT_TARGET=13.0 \
                -DAPPEND_CPPFLAGS="-I$(brew --prefix libevent)/include"
          CORES=$(sysctl -n hw.ncpu)
          cmake --build . --config Release -j$CORES
          
      - name: Deploy Nunchuk
        working-directory: ${{ github.workspace }}/build
        env:
          APP_PATH: "${{ github.workspace }}/build/Nunchuk.app"
        run: |
          set -e
          source ~/.bashrc
          export PATH="/usr/local/opt/qt@5/bin:$PATH"
          export LDFLAGS="$LDFLAGS -L/usr/local/opt/qt@5/lib -L$HOME/boost-1.81.0/lib -L/usr/local/opt/berkeley-db@4/lib"
          export CPPFLAGS="$CPPFLAGS -I/usr/local/opt/qt@5/include -I$HOME/boost-1.81.0/include -I/usr/local/opt/berkeley-db@4/include -I$OPENSSL_ROOT_DIR/include"
          export BOOST_ROOT="$HOME/boost-1.81.0"
          
          find ${{ github.workspace }} -name "Nunchuk.app"
          macdeployqt $APP_PATH \
                      -executable=$APP_PATH/Contents/MacOS/Nunchuk \
                      -qmldir=${{ github.workspace }}/nunchuk-desktop \
                      -always-overwrite

      - name: Patch QtWebEngineProcess dependencies
        working-directory: ${{ github.workspace }}/build
        env:
          APP_PATH: "${{ github.workspace }}/build/Nunchuk.app"
        run: |
          HELPER_PATH="$APP_PATH/Contents/Frameworks/QtWebEngineCore.framework/Versions/5/Helpers/QtWebEngineProcess.app"
          HELPER_EXEC="$HELPER_PATH/Contents/MacOS/QtWebEngineProcess"
          HELPER_FRAMEWORKS="$HELPER_PATH/Contents/Frameworks"
          
          install_name_tool -delete_rpath "@executable_path/../Frameworks" "$HELPER_EXEC"
          install_name_tool -add_rpath "@executable_path/../../../../../../../../Frameworks" "$HELPER_EXEC"
          # B·∫Øt m·ªçi Qt*.framework d√π ·ªü ƒë√¢u
          DEPS=$(otool -L "$HELPER_EXEC" | awk '{print $1}' | grep -E "Qt[^/]+\.framework")
          
          if [ -z "$DEPS" ]; then
            echo "‚ö†Ô∏è No Qt dependencies found needing patch."
          else
            echo "$DEPS" | while read -r dep; do
              basename=$(basename "$dep")
              framework=$(echo "$dep" | sed -E 's|.*/(Qt[^/]+)\.framework.*|\1|')
              new_path="@executable_path/../../../../../../../${framework}.framework/Versions/5/${framework}"
              echo "üîß Fixing: $dep ‚Üí $new_path"
              install_name_tool -change "$dep" "$new_path" "$HELPER_EXEC"
            done
          fi
          
          echo "‚úÖ Done patching QtWebEngineProcess dependencies."
          # Check result
          echo "-- CHECK OTOOL AGAIN --"
          otool -L "$HELPER_EXEC"
